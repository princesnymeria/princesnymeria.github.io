<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

	<title>Perlinolor</title>
	
	<script src="../../p5.js"></script>
</head>

<style>
	body {
		padding: 0;
		margin: 0;
		height: 100vh;
		width: 100vw;
		border: none;
		overflow: hidden;
	}
</style>

<body></body>

<script>
	const MODE_DEBUG = true;
	const brushes = [];
	let img;

	function preload() {
		img = loadImage('img.jpg');
	}

	function setup() {
		createCanvas(window.innerWidth, window.innerHeight);
		frameRate(12);

		setStyle();
		loadBrushes(100);//loadBrushes(floor(width * .5));
	}

	function draw() {
		brushes.forEach(b => {
			b.update();
			b.checkMargin();
			b.display();
		});
	}

	function setStyle() {
		background(12);
		colorMode(HSL);
		noFill();
		stroke(0, 60, 60);
		angleMode(RADIANS);
		smooth();
	}

	function loadBrushes(count) {
		const randomColorMode = random(0,1) > .7 ? 'randomHue' : 'knowonHue';
		const colorHue = random(0, 360);
		for (let i = 0; i < count; i++) {
			var c;
			if (randomColorMode == 'randomHue') c = color(random(0, 255), 60, 60);
			else c = color(colorHue, random(10, 90), random(10, 90));
			const s = random(2, 6);
			brushes.push(new Brush(s, c));
		}
	}

	class Brush {
		constructor (size, color) {
			this.pos = createVector(random(0, width), random(0, height));
			this.color = color;
			this.size = size;
		}
		update () {
			const s = 600;
			const v = .4;
			const p = img.get(this.pos.x/s, this.pos.y/s)[1];
			const a = map(p, 0, 360, 0, TAU);
			this.pos.x += cos(a) * v;
			this.pos.y += sin(a) * v;
		}
		display () {
			stroke(this.color);
			strokeWeight(this.size);
			point(this.pos.x, this.pos.y);
		}
		checkMargin () {
			if (this.pos.x < 0) this.pos.x = width;
			if (this.pos.x > width) this.pos.x = 0;
			if (this.pos.y < 0) this.pos.y = height;
			if (this.pos.y > height) this.pos.y = 0;
		}
	}
</script>

</html>