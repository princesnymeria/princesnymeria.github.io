<!DOCTYPE html>

<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">

		<title>Sunflower</title>
		
		<script src="../p5.js"></script>
	</head>

	<style>
		body {
			padding: 0;
			margin: 0;
			height: 100vh;
			width: 100vw;
			border: none;
			overflow: hidden;
		}
	</style>

	<body></body>

	<script>
		const MODE_DEBUG = false;
		const seeds = [];
		var controller;
		var CANVAS_WIDTH, CANVAS_HEIGHT;

		const COLOR_HUE_0 = 180;
		const COLOR_HUE_1 = 240; // const COLOR_HUE_1 = 300;
		const SEEDS_COUNT = MODE_DEBUG ? 15 : 600;
		const SEEDS_SPACE = MODE_DEBUG ? 50 : 8;

		function setup() {
			CANVAS_WIDTH = window.innerWidth;
			CANVAS_HEIGHT = window.innerHeight;
			
			createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
			frameRate(24);

			colorMode(HSL);
			angleMode(RADIANS);

			controller = new Controller( (CANVAS_WIDTH > CANVAS_HEIGHT ? CANVAS_WIDTH : CANVAS_HEIGHT) * .1 );
			const l = setParticlesPosition(SEEDS_COUNT, SEEDS_SPACE);

			var colorHue = COLOR_HUE_0;
			const colorIncr = (COLOR_HUE_1 - COLOR_HUE_0) / l.length;
			l.forEach(pos => {
				seeds.push(new Seed(pos, colorHue));
				colorHue += colorIncr;
			});
		}

		function draw() {
			clearCanvas();
			controller.setPos(mouseX, mouseY);
			seeds.forEach(bala => {
				bala.collide(controller);
				bala.update();
				bala.display();
			});
			controller.display();
		}
		
		function setStrokeStyle(type, color) {
			if      ( type == 'line' )  { strokeWeight(1);  stroke(0, 0, 50);      }
			else if ( type == 'point' ) { strokeWeight(10); stroke(color, 60, 60); }
		}
		
		function clearCanvas() {
			background(12);
		}
		
		function setParticlesPosition(count, spacing) {
			const positions = [];
			const A = 275 * PI / 360;
			for (let i = 0; i < count; i++) {
				let a = i * A;
				let r = spacing * sqrt(i);
				let x = r * cos(a) + CANVAS_WIDTH * .5;
				let y = r * sin(a) + CANVAS_HEIGHT * .5;
				positions.push( createVector(x, y) );
			}
			return positions;
		}

		class Seed {
			constructor (positionVector, colorHue) {
				this.hue = colorHue;
				this.pos0 = positionVector;
				this.pos1 = positionVector;
				this.acc = 0;
				this.angle = 0;
				this.v = 0;
				this.k = .005;
				this.t = 0;
			}
			update () {
				const d = dist (this.pos0.x, this.pos0.y, this.pos1.x, this.pos1.y);
				if ( (d < abs(this.v) || d < 1) && this.t > 5 ) {
					this.acc *= -1;
					this.t = 0
					if (abs(this.acc) < .05) {
						this.acc = 0;
						this.angle = 0;
						this.v = 0;
						this.pos1 = this.pos0;
					}
				}
				this.v += this.acc;
				this.pos1.x += cos(this.angle) * this.v;
				this.pos1.y += sin(this.angle) * this.v;
				if ( abs(this.v) < .01 ) {
					this.acc *= .3;
				}
				this.t++;
			}
			display () {
				if (MODE_DEBUG) this.displayHelpers();
				setStrokeStyle('line', 0)
				line(this.pos0.x, this.pos0.y, this.pos1.x, this.pos1.y);
				setStrokeStyle('point', this.hue)
				point(this.pos1.x, this.pos1.y);
			}
			setPos (pX, pY) {
				this.pos1 = createVector(pX, pY);
				const d = dist(this.pos0.x, this.pos0.y, pX, pY);
				this.v = 0;
				this.acc = this.k * d;
				this.angle = atan( (this.pos1.y - this.pos0.y) / (this.pos1.x -this.pos0.x) );
				if (this.pos1.x > this.pos0.x) this.angle += PI
			}
			collide (that) {
				if ( this.isColliding(that) )
					this.moveAwayFrom(that.pos.x, that.pos.y, that.diameter)
			}
			moveAwayFrom (otherX, otherY, otherDim) {
				const dx = this.pos1.x - otherX;
				const dy = this.pos1.y - otherY;
				const v = this.pos1.x > otherX ? 0 : PI;
				const a = atan( dy/dx ) + v;
				const x = this.pos1.x + cos(a) * 5 ;
				const y = this.pos1.y + sin(a) * 5 ;
				if (abs(this.acc) < .1) this.setPos(x, y);
			}
			isColliding (that) {
				const d = dist(this.pos1.x, this.pos1.y, that.pos.x, that.pos.y);
				const res = d < that.diameter * .5 + 5;
				return res;
			}
			displayHelpers () {
				noStroke();
				fill('#FFFF0020');
				circle(this.pos1.x, this.pos1.y, this.v * 10);
				fill('#00FFFF20');
				circle(this.pos1.x, this.pos1.y, abs(this.acc * 1000));
			}
		}
		class Controller {
			constructor (diameter) {
				this.diameter  = diameter;
				this.pos = createVector(0, 0);
			}
			display () {
				noStroke();
				fill(16);
				circle(this.pos.x, this.pos.y, this.diameter);
			}
			setPos (pX, pY) {
				this.pos.x = pX;
				this.pos.y = pY;
			}
		}
	</script>

</html>